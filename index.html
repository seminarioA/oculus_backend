<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Webcam Stream Binario & TTS (Auto Audio)</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #eee; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; padding: 20px; }
        .card { background: #333; padding: 20px; border-radius: 8px; border: 1px solid #444; }
        h2 { margin-top: 0; color: #4ade80; }
        .log { height: 150px; overflow-y: auto; background: #000; font-family: monospace; padding: 10px; text-align: left; font-size: 12px; }
        #video-container { display: flex; flex-direction: column; align-items: center; }
        #camera-feed, #img-out { width: 100%; max-width: 320px; height: auto; border: 2px solid #4ade80; }
        #capture-canvas { display: none; }
        #btn-audio { display: none; }
    </style>
</head>
<body>

    <h1>Streaming de C√°mara Real (Binario) & TTS</h1>

    <div class="grid">
        <div class="card" id="video-container">
            <h2>üì§ Video In (Tu C√°mara)</h2>
            <video id="camera-feed" autoplay muted playsinline></video>
            <canvas id="capture-canvas"></canvas>
            <p>Estado de Env√≠o: <span id="send-status" style="color: cyan;">Esperando c√°mara...</span></p>
        </div>

        <div class="card" id="video-container">
            <h2>üì• Video Out</h2>
            <img id="img-out" src="" alt="Esperando stream del servidor..." />
            <p>Recibiendo stream procesado...</p>
        </div>

        <div class="card">
            <h2>üó£Ô∏è TTS (Audio)</h2>
            <div id="log-tts" class="log" style="color: yellow;"></div>
        </div>
    </div>

    <script>
        const BASE_URL = "ws://3.135.187.120";
        let audioActivo = true;
        let streamInterval = null;

        const videoElement = document.getElementById('camera-feed');
        const canvas = document.getElementById('capture-canvas');
        const context = canvas.getContext('2d');
        const sendStatus = document.getElementById('send-status');

        // --- FUNCI√ìN PRINCIPAL DE ENV√çO DE VIDEO BINARIO ---
        function sendBinaryFrame() {
            if (wsIn.readyState === WebSocket.OPEN) {
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob(function(blob) {
                    if (wsIn.readyState === WebSocket.OPEN) {
                        wsIn.send(blob);
                        sendStatus.innerText = `Enviando ${blob.size} bytes (1 FPS)...`;
                    }
                }, 'image/jpeg', 0.6);
            }
        }

        // --- 1. VIDEO IN ---
        const wsIn = new WebSocket(`${BASE_URL}/video/in`);
        
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoElement.srcObject = stream;
                
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    // ENV√çO A 1 FPS ‚Üí 1000 ms
                    streamInterval = setInterval(sendBinaryFrame, 1000);
                    sendStatus.innerText = "C√°mara conectada, enviando 1 frame por segundo.";
                };
            })
            .catch(err => {
                sendStatus.innerText = `Error al acceder a la c√°mara: ${err.name}`;
                console.error("Error al acceder a la c√°mara:", err);
            });

        wsIn.onclose = () => {
            clearInterval(streamInterval);
            sendStatus.innerText = "¬°Env√≠o desconectado!";
        };

        // --- 2. VIDEO OUT ---
        const wsOut = new WebSocket(`${BASE_URL}/video/out`);
        const imgOut = document.getElementById("img-out");

        wsOut.binaryType = 'blob';

        wsOut.onmessage = (event) => {
            const blob = event.data;
            if (imgOut.src && imgOut.src.startsWith('blob:')) {
                URL.revokeObjectURL(imgOut.src);
            }
            imgOut.src = URL.createObjectURL(blob);
        };

        // --- 3. TTS ---
        const wsTTS = new WebSocket(`${BASE_URL}/tts`);
        const logTTS = document.getElementById("log-tts");

        wsTTS.onmessage = (event) => {
            const texto = event.data;
            logTTS.innerHTML = `üîä "${texto}"<br>` + logTTS.innerHTML;

            if (audioActivo) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(texto);
                utterance.lang = "es-ES";
                window.speechSynthesis.speak(utterance);
            }
        };

        setTimeout(() => {
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Sistema activado."));
        }, 1000);
    </script>
</body>
</html>
